#!/bin/sh
set -e
. asroot
modprobe -r kvm-intel kvm pcspkr applesmc iwlmvm iwlwifi \
         mac80211 cfg80211 btusb btbcm btintel btrtl bluetooth || true

echo '1' >/sys/module/snd_hda_intel/parameters/power_save
echo 'min_power' | tee >/dev/null /sys/class/scsi_host/host*/link_power_management_policy
echo '1' | tee >/dev/null /sys/bus/usb/devices/*/power/autosuspend
echo 'auto' | tee >/dev/null /sys/devices/**/power/control
echo 'auto' | tee >/dev/null /sys/bus/pci/devices/**/power/control
#echo 5000 > /proc/sys/vm/dirty_expire_centisecs

for f in $(find /sys/devices -name product -type f \
                -exec grep -l '\(Keyboard\|Mouse\)' {} \;); do
    echo 0 >$(dirname $f)/power/autosuspend || echo "Hum $f"
done

# Following

ethtool -s eno1 wol d
#echo 0 >/sys/class/rtc/rtc0/wakealarm
#date -u --date '+3 sec' +%s >/sys/class/rtc/rtc0/wakealarm
#echo 'mem' >/sys/power/state
