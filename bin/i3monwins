#!/bin/sh
set -e

w() {
    winlist=$(xdotool search --desktop $desktop --name . | sort)
    wins=0
    aid=$(($1))
    for wid in $winlist; do
        wins=$((wins+1))
        test "$wid" = "$aid" && anum=$wins
    done
    set -- $(xprop -notype -root _NET_DESKTOP_NAMES)
    shift $((desktop+2))
    eval dname="${@%%,*}"
    case $wins in
        0) wincap="{}";;
        1) wincap="{1}";;
        *) wincap="{$anum/$wins}";;
    esac
    printf "\002$dname$wincap"
}

xprop -notype -root -spy _NET_CURRENT_DESKTOP _NET_ACTIVE_WINDOW | {
    while read _ _ n; do
        expr "$n" : "id" >/dev/null && {
            set -- $n
            w $3
        } || {
            desktop=$n
        }
    done
}
