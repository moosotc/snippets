#!/bin/sh
set -e

w() {
    winlist=$(xdotool search --desktop $desktop --name . | sort)
    test -z "$winlist" && {
        printf "\002"
        return
    }
    wins=0
    aid=$(($1))
    for wid in $winlist; do
        wins=$((wins+1))
        test "$wid" = "$aid" && anum=$wins
    done
    set -- $(xprop -notype -root _NET_DESKTOP_NAMES)
    shift $((desktop+2))
    eval dname="${@%%,*}"
    test $wins -gt 1 && wincap="{$anum/$wins}" || wincap="{1}"
    printf "\002$dname$wincap"
}

xprop -notype -root -spy _NET_CURRENT_DESKTOP _NET_ACTIVE_WINDOW | {
    while read _ _ n; do
        expr "$n" : "id" >/dev/null && {
            set -- $n
            w $3
        } || {
            desktop=$n
        }
    done
}
