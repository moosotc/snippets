#!/bin/sh
set -e

w() {
    wincount=0
    aid=$(($1))
    set -- $(xdotool search --desktop $desktop --name . | sort)
    for wid; do
        wincount=$((wincount+1))
        test "$wid" = "$aid" && anum=$wincount
    done
    set -- $(xprop -notype -root _NET_DESKTOP_NAMES)
    shift $((desktop+2))
    eval dname="${@%%,*}"
    case $wincount in
        0) wincap="{}";;
        1) wincap="{1}";;
        *) wincap="{$anum/$wincount}";;
    esac
    printf "\002$dname$wincap"
}

exec xprop -notype -root -spy _NET_CURRENT_DESKTOP _NET_ACTIVE_WINDOW |
    while read _ _ n; do
        expr "$n" : "id" >/dev/null && {
            set -- $n
            w $3
        } || {
            desktop=$n
        }
    done
