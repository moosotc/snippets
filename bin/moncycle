#!/bin/sh
set -eu
exec 2>/dev/null 1>&2

lsmod | grep -q i2c_dev || (
    . asroot
    modprobe i2c-dev
)

name2id() {
    case "$1" in
        dp*) echo 15;;
        minidp*) echo 16;;
        hdmi1*) echo 17;;
        hdmi2*) echo 18;;
        *) echo $default;;
    esac
}
default=$(name2id "dp")

expr >/dev/null "$(ddcci-tool /dev/i2c-8 -r 0x60)" : ".*+/$default/" || {
    ddcci-tool /dev/i2c-8 -r 0x60 -w $default
}

name=$(printf "dp (linmac2)\nminidp\nhdmi1 (ps4)\nhdmi2 (switch/linmacM)\n" \
           | rofi -dmenu -p "Video Input:")
id=$(name2id $name)
test $id = $default || ddcci-tool /dev/i2c-8 -r 0x60 -w $id
