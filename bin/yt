#!/bin/sh
set -e
ctl=/tmp/i3.fifo

test "$1" = "-v" && {
    shift
    set -x
} || {
    exec 1>/dev/null
    exec 2>/dev/null
}

test "$1" = "-b" && {
    shift
    exec mpv "$@"
}
yt="youtube-dl"

test -z "$1" && arg=$(xclip -o -selection clipboard) || { arg="$1"; shift; }
test -n "$arg" && expr "$arg" : ".*chessgames" && exec Anal
test -z "$arg" && {
    echo "nothing to show"
    exit 1
}

expr "$arg" : ".*\.\(pdf\|html\|jpg\?\)$" && {
    expr "$arg" : ".*cnn\.com.*" || {
        exec llppac "$arg"
    } && true
}

trap "printf '\001' >$ctl" 0

title="$arg"
printf "ðŸ…¥ $title" >$ctl
printf "%s" "ðŸ†… $($yt -e $arg)" >$ctl &

expr "$arg" : ".*cnn.*" && {
    url=$(strace -o /dev/null -f -c youtube-dl -f 1280x720_3500k -g "$arg")
    tmux new-window -n "$url" mpv --quiet "$url" || printf 'nevidos' >$ctl
} || {
    tmux new-window -n "$title"                                             \
         mpv --quiet "$arg"                                                 \
         --ytdl-raw-options no-playlist= --ytdl-format '[width<=1280]' ||   \
        printf 'nevidos' >$ctl
}
xdotool search --sync mpv && :>$ctl || echo xdotool failed >$ctl
